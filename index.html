<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SWAPTFS • B737 QRH</title>
<meta name="theme-color" content="#1d2f6f">
<style>
:root{
  --bg:#0b1220;
  --panel:#0f1a32;
  --card:#0d1530;
  --ink:#eaf1ff;
  --muted:#9fb0d1;
  --brand:#1d2f6f;
  --accent:#f9ba00;
  --danger:#c62828;
  --success:#1b5e20;
  --border:#1e2a48;
  --green:#1faa00;
  --radius:18px;
  --shadow:0 14px 36px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#0a1020 60%,#071027 100%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
.container{display:grid;grid-template-columns:320px 1fr;gap:18px;height:100vh;padding:18px}
.left{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:var(--shadow)}
.right{display:flex;flex-direction:column;gap:18px;overflow:hidden}
.header{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;box-shadow:var(--shadow)}
.brand{display:flex;align-items:center;gap:12px}
.badge{background:rgba(249,186,0,.12);color:var(--accent);border:1px solid rgba(249,186,0,.35);padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px;letter-spacing:.25px}
.title{font-size:20px;font-weight:700;line-height:1.1}
.sub{font-size:12px;color:var(--muted)}
.tools{display:flex;gap:10px;align-items:center}
button, .btn{appearance:none;border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s transform,.2s opacity;box-shadow:0 8px 18px rgba(29,47,111,.35)}
button:active,.btn:active{transform:translateY(1px)}
button.ghost{background:transparent;border:1px solid var(--border);color:var(--ink);box-shadow:none}
button.warn{background:var(--danger)}
.toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:transparent;color:var(--ink);padding:8px 12px;border-radius:999px;font-weight:600}
.input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--ink);outline:none}
.search{display:flex;gap:8px}
.nav{display:flex;flex-direction:column;gap:10px;overflow:auto}
.section{display:flex;flex-direction:column;gap:8px}
.group-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.2em;margin-top:6px}
.navbtn{width:100%;text-align:left;padding:12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--ink);font-weight:650;cursor:pointer}
.navbtn.active{outline:3px solid rgba(249,186,0,.22);border-color:rgba(249,186,0,.55);background:rgba(249,186,0,.06)}
.main{flex:1;min-height:0;display:grid;grid-template-rows:auto 1fr;gap:12px}
.content{overflow:auto;border:1px solid var(--border);background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.cards{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:14px}
.card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
@media(min-width:900px){
  .card.half{grid-column:span 6}
  .card.third{grid-column:span 4}
}
.card h3{margin:0 0 8px 0;font-size:16px}
.kv{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.kv .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
.list{display:flex;flex-direction:column;gap:8px}
.step{display:flex;align-items:flex-start;gap:10px}
.chk{min-width:22px;height:22px;border-radius:8px;border:2px solid rgba(255,255,255,.22);display:grid;place-items:center;cursor:pointer;user-select:none}
.chk.done{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:transparent}
.step p{margin:0;line-height:1.35}
.tag{font-size:12px;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.sticky-immediate{position:sticky;top:0;z-index:3;background:linear-gradient(180deg,rgba(10,17,35,.96),rgba(10,17,35,.86));border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
.sticky-immediate h2{margin:0 0 8px 0;font-size:15px;color:#fff}
.quick-index{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.quick-index .q{border:1px solid var(--border);background:rgba(255,255,255,.02);padding:12px;border-radius:12px;cursor:pointer;font-weight:650}
.login-wrap{height:100vh;display:grid;place-items:center;padding:18px}
.login{width:100%;max-width:420px;background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:22px;display:flex;flex-direction:column;gap:12px;box-shadow:var(--shadow)}
.logo{display:flex;align-items:center;gap:10px}
.logo mark{background:rgba(249,186,0,.18);color:var(--accent);padding:4px 8px;border-radius:999px}
.small{font-size:12px;color:var(--muted)}
.footer{display:flex;gap:8px;flex-wrap:wrap}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0c1a36;border:1px solid var(--border);border-radius:8px;padding:2px 6px;font-size:12px}
.hide{display:none}
hr.sep{border:0;border-top:1px solid var(--border);margin:12px 0}
h1{margin:0;font-size:18px}
h2{margin:0 0 8px 0;font-size:16px}
h4{margin:6px 0 8px 0;font-size:13px;color:var(--muted);font-weight:700;letter-spacing:.08em;text-transform:uppercase}
.controls{display:flex;gap:8px;flex-wrap:wrap}
a.link{color:var(--accent);text-decoration:none;border-bottom:1px dotted rgba(249,186,0,.5)}
.compact .content{padding:12px}
.compact .card{padding:12px}
.compact .step p{font-size:14px}
.bigtext .content{font-size:18px}
</style>
</head>
<body>
<div id="gate" class="login-wrap">
  <div class="login">
    <div class="logo">
      <div style="width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:radial-gradient(120px 120px at -20% -20%, #2a4ac7 0%, transparent 60%), radial-gradient(120px 120px at 120% 120%, #e21a1a 0%, transparent 60%), linear-gradient(135deg,#102568,#0d1a4a)"></div>
      <div>
        <div class="title">SWAPTFS • B737 QRH</div>
        <div class="sub">Restricted: Pilot Portal</div>
      </div>
    </div>
    <div class="badge">Revision 1.0 • Effective Sep 2025</div>
    <input id="pass" class="input" type="password" placeholder="Enter access code"/>
    <div class="tools">
      <button id="unlock">Unlock</button>
      <button id="remember" class="toggle"><span>Remember device</span></button>
    </div>
    <div class="small">Access is for authorized SWAPTFS flight crew. Use in good judgment and fly the airplane first.</div>
    <hr class="sep"/>
    <div class="footer">
      <span class="small">Hotkeys:</span><span class="kbd">/</span><span class="small">Search</span><span class="kbd">G</span><span class="small">Quick Index</span><span class="kbd">I</span><span class="small">Immediate</span><span class="kbd">B</span><span class="small">Big Text</span>
    </div>
  </div>
</div>

<div id="app" class="container hide">
  <aside class="left">
    <div class="search">
      <input id="search" class="input" placeholder="Search: e.g. fire, stall, depressurize"/>
      <button id="clear" class="ghost">Clear</button>
    </div>
    <div class="section">
      <div class="group-title">Quick Action Index</div>
      <div id="quick" class="quick-index"></div>
    </div>
    <div class="section">
      <div class="group-title">Chapters</div>
      <div id="nav" class="nav"></div>
    </div>
    <div class="section">
      <div class="group-title">Display</div>
      <div class="tools">
        <button id="big" class="toggle">Big Text</button>
        <button id="compact" class="toggle">Compact</button>
        <button id="logout" class="toggle">Lock</button>
      </div>
    </div>
  </aside>

  <main class="right">
    <div class="header">
      <div class="brand">
        <div style="width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:conic-gradient(from 120deg,#f9ba00 0 40%,#1d2f6f 40% 65%,#e21a1a 65% 100%)"></div>
        <div>
          <div class="title">SWAPTFS • B737 QRH</div>
          <div class="sub">Single-page rapid reference for emergencies & abnormals</div>
        </div>
      </div>
      <div class="tools">
        <span class="badge">PTFS Ops</span>
        <button id="immediateOnly" class="toggle">Immediate Only</button>
      </div>
    </div>

    <section class="main">
      <div id="sticky" class="sticky-immediate hide">
        <h2>Immediate Actions</h2>
        <div id="stickyList" class="list"></div>
      </div>
      <div class="content">
        <div id="cards" class="cards"></div>
      </div>
    </section>
  </main>
</div>

<script>
const PASS_HASH="f195271371b6261f40ea223e33350509a0c59839e262e3a0b35fcad76540a7e9";
const chapters=[
  {
    id:"intro",
    title:"INTRO",
    tags:["about","overview","policy"],
    blocks:[
      {type:"kv",items:[
        ["Aircraft","Boeing 737NG (PTFS)"],
        ["Document","Quick Reference Handbook (QRH)"],
        ["Revision","1.0"],
        ["Effective","September 2025"]
      ]},
      {type:"text",html:"This Quick Reference Handbook provides standardized procedures for handling emergencies and abnormal situations in the PTFS Boeing 737NG. It is adapted from the real Boeing 737NG QRH but streamlined to reflect PTFS operations. The goal is to deliver clear, concise guidance for the most relevant scenarios while maintaining the professionalism and structure of real-world airline operations."},
      {type:"text",html:"Please refer to FCOM Section 2.1 for more QRHs and Quick Reference Handbooks information."},
      {type:"text",html:"Any questions, comments, or errors? Contact <strong>axitheaviator</strong> on Discord."},
      {type:"text",html:"Signed,<br><strong>axitheaviator</strong><br>Chief Executive Officer<br><span class='tag'>southwestptfs.com</span>"}
    ]
  },
  {
    id:"index",
    title:"QUICK ACTION INDEX",
    tags:["index","menu","home"],
    blocks:[
      {type:"quick",items:[
        ["ENG 1 FAIL","eng1"],
        ["ENG 2 FAIL","eng2"],
        ["DUAL ENGINE FAIL","dual"],
        ["ENGINE SURGE / STALL","surge"],
        ["ENGINE FIRE / SEVERE DAMAGE","fire"],
        ["GEAR FAILURE (EXTEND/RETRACT)","gear"],
        ["FLIGHT CONTROL FAILURE (HYDRAULIC LOSS)","fctl"],
        ["CABIN DEPRESSURIZATION","depr"],
        ["EMERGENCY EVACUATION","evac"]
      ]}
    ]
  },
  {
    id:"eng1",
    title:"ENG 1 FAIL",
    tags:["engine","fail","left","single engine","rto","v1"],
    immediate:[
      "PF: Maintain aircraft control (pitch, attitude, heading).",
      "PM: Call out: “Engine 1 Fail.”",
      "Thrust Lever (Engine 1): IDLE",
      "Engine Start Lever (Engine 1): CUTOFF"
    ],
    checklist:[
      "Fuel Pumps (Left Side): OFF",
      "Crossfeed: AS REQUIRED",
      "Evaluate if a restart is possible",
      "If engine fire/severe damage is suspected → Refer to Engine Fire / Severe Damage"
    ],
    rolesPF:"Flies the aircraft, commands checklist execution, monitors airspeed, and climbs.",
    rolesPM:"Reads the checklist, verifies, and executes when directed.",
    notes:[
      {h:"Before V1 (RTO)",items:[
        "A Rejected Takeoff (RTO) is permitted if runway length, surface conditions, and aircraft performance allow.",
        "PF calls “Abort.” PM assists with thrust reduction, spoilers, and braking."
      ]},
      {h:"RTO Approval Conditions",items:[
        "Sufficient runway remaining to stop.",
        "Dry or otherwise suitable runway surface.",
        "Aircraft under control; no asymmetric braking/steering loss.",
        "No obstacles or hazards ahead."
      ]},
      {h:"After V1",items:[
        "Continue the takeoff.",
        "PF maintains directional control, rotates at VR, climbs on one engine.",
        "Run QRH once safely airborne."
      ]},
      {h:"Approach",items:[
        "Go-around if unstable.",
        "Plan a longer, more gradual single-engine approach; verify runway length.",
        "Use autopilot if available until short final to reduce workload.",
        "Maintain higher thrust on operative engine; brief degraded go-around.",
        "PM closely monitors instruments and calls deviations early."
      ]},
      {h:"Short Final",items:[
        "Stabilized by 500 ft AGL (VMC) / 1,000 ft AGL (IMC).",
        "Gear down 3 green; landing flaps set.",
        "Maintain centerline with rudder to counter asymmetric thrust.",
        "Slightly higher Vapp acceptable; avoid excessive speed."
      ]},
      {h:"Landing",items:[
        "Touch down in the first third; no long landings.",
        "Thrust lever of operative engine IDLE at touchdown.",
        "Maintain centerline with rudder, brake smoothly; expect longer stop.",
        "Single-engine go-around only if necessary.",
        "If evacuation required, see EMERGENCY EVACUATION."
      ]}
    ]
  },
  {
    id:"eng2",
    title:"ENG 2 FAIL",
    tags:["engine","fail","right","single engine","rto","v1"],
    immediate:[
      "PF: Maintain aircraft control (pitch, attitude, heading).",
      "PM: Call out: “Engine 2 Fail.”",
      "Thrust Lever (Engine 2): IDLE",
      "Engine Start Lever (Engine 2): CUTOFF"
    ],
    checklist:[
      "Fuel Pumps (Right Side): OFF",
      "Crossfeed: AS REQUIRED",
      "Evaluate if a restart is possible",
      "If engine fire/severe damage is suspected → Refer to Engine Fire / Severe Damage"
    ],
    rolesPF:"Flies the aircraft, commands checklist execution, monitors airspeed, and climbs.",
    rolesPM:"Reads the checklist, verifies, and executes when directed.",
    notes:[
      {h:"Before V1 (RTO)",items:[
        "RTO permitted if runway/conditions/performance allow.",
        "PF “Abort.” PM handles spoilers and braking."
      ]},
      {h:"RTO Approval Conditions",items:[
        "Sufficient runway remaining.",
        "Suitable surface.",
        "Aircraft under control.",
        "No hazards ahead."
      ]},
      {h:"After V1",items:[
        "Continue takeoff, rotate at VR, climb on one engine.",
        "Run QRH once airborne."
      ]},
      {h:"Approach",items:[
        "Go-around if unstable.",
        "Plan single-engine profile; verify runway length.",
        "Use autopilot if available until short final.",
        "Higher thrust on operative engine; brief reduced go-around.",
        "PM monitors and calls deviations."
      ]},
      {h:"Short Final",items:[
        "Stabilized by 500 ft (VMC) / 1,000 ft (IMC).",
        "Gear down 3 green; landing flaps set.",
        "Maintain centerline with rudder.",
        "Avoid excessive speed."
      ]},
      {h:"Landing",items:[
        "Touch down in first third.",
        "Operative engine IDLE at touchdown.",
        "Brake smoothly; longer stop expected.",
        "Go-around only if necessary.",
        "If evacuation required, see EMERGENCY EVACUATION."
      ]}
    ]
  },
  {
    id:"dual",
    title:"DUAL ENGINE FAIL",
    tags:["dual","both engines","flameout","glide","apulstart","restart"],
    immediate:[
      "PF: Maintain control; pitch for best glide (≈250–300 kts PTFS).",
      "PM: Call out: “Dual Engine Failure.”",
      "Start Switches (BOTH): CONT",
      "Thrust Levers (BOTH): IDLE",
      "Engine Start Levers (BOTH): CUTOFF → then IDLE (attempt relight)"
    ],
    checklist:[
      "APU: START",
      "Fuel Pumps: ON",
      "Crossfeed: AS REQUIRED",
      "Attempt windmill restart if speed allows",
      "If restart fails: prepare for diversion, forced landing, or ditching"
    ],
    rolesPF:"Controls glide; selects nearest safe runway or ditching area.",
    rolesPM:"Runs restart attempts, monitors speed/altitude, communicates with ATC.",
    notes:[
      {h:"Before V1 (RTO)",items:[
        "RTO permitted if runway/conditions/performance allow.",
        "PF “Abort.” PM assists with spoilers and braking."
      ]},
      {h:"After V1",items:[
        "Continue takeoff; climb will be severely compromised.",
        "PF sets glide attitude; PM calls speed/indications.",
        "Begin restart attempts when safe; if unsuccessful, plan immediate return/landing."
      ]},
      {h:"Approach",items:[
        "If unstable, commit to forced landing; go-around not possible without power.",
        "Commit early to runway/area; confirm stopping distance.",
        "Configure early; avoid last-second changes.",
        "PF holds glide (≈280–250 kts PTFS). PM runs restart until landing committed."
      ]},
      {h:"Short Final",items:[
        "Fully configured before short final.",
        "Use pitch to control path; no thrust available.",
        "Establish crosswind corrections early; stabilize speed."
      ]},
      {h:"Landing Roll",items:[
        "No reverse thrust; expect longer stop.",
        "Use spoilers if available; apply maximum braking early.",
        "Prepare for runway overrun or off-field landing.",
        "Initiate evacuation as required."
      ]}
    ]
  },
  {
    id:"surge",
    title:"ENGINE SURGE / STALL",
    tags:["surge","stall","bang","pop","smoke","fluctuation"],
    immediate:[
      "PF: Maintain control.",
      "PM: Call out surge/stall.",
      "Thrust Lever (affected): IDLE"
    ],
    checklist:[
      "If condition clears: cautiously advance thrust.",
      "If persists: execute ENG FAIL checklist."
    ],
    rolesPF:"",
    rolesPM:"",
    notes:[
      {h:"Considerations",items:[
        "On approach: assess go-around to stabilize before corrective actions.",
        "Before V1: consider RTO if runway/conditions permit.",
        "After V1: continue takeoff; treat as engine failure.",
        "For landing: follow single-engine approach guidance."
      ]}
    ]
  },
  {
    id:"fire",
    title:"ENGINE FIRE / SEVERE DAMAGE",
    tags:["fire","severe damage","vibration","bang"],
    immediate:[
      "PF: Maintain control.",
      "PM: “Engine Fire / Severe Damage [side]”.",
      "Thrust Lever (affected): IDLE",
      "Engine Start Lever (affected): CUTOFF",
      "Engine Fire Switch (affected): PULL",
      "Engine Fire Switch: Rotate to discharge"
    ],
    checklist:[
      "If fire light remains: rotate to use second bottle.",
      "Fuel Pumps (affected): OFF",
      "Crossfeed: AS REQUIRED",
      "Plan for single-engine ops (see ENG FAIL).",
      "Divert to the nearest suitable airport."
    ],
    rolesPF:"Maintains flight path; commands execution.",
    rolesPM:"Runs memory items and fire drill; confirms shutdown/isolation; communicates with ATC.",
    notes:[
      {h:"References",items:[
        "For takeoff/landing and single-engine profiles, see ENG 1 FAIL / ENG 2 FAIL."
      ]}
    ]
  },
  {
    id:"gear",
    title:"GEAR FAILURE (EXTEND/RETRACT)",
    tags:["gear","landing gear","unsafe","alternate extension","belly landing"],
    immediate:[
      "PF: Maintain control; do not exceed 250 kts.",
      "PM: “Gear Failure/Unsafe”."
    ],
    checklist:[
      "Alternate Gear Extension: PULL",
      "Confirm three green (down/locked)",
      "If unsafe/partial: prepare for belly or asymmetrical landing",
      "Brief crew and passengers",
      "Notify ATC of emergency landing"
    ],
    rolesPF:"Fly the approach/landing.",
    rolesPM:"Run checklist, confirm indications, communicate with ATC, prepare cabin.",
    notes:[
      {h:"Belly Landing",items:[
        "Flaps 15 (PTFS Flaps 3).",
        "Touch down smoothly in TDZ.",
        "Cut engines at touchdown.",
        "Evacuate per EMERGENCY EVACUATION."
      ]},
      {h:"Asymmetrical Gear",items:[
        "Land on the extended-gear side.",
        "Expect veer toward failed side; maintain rudder through rollout.",
        "Use differential braking if possible."
      ]},
      {h:"Fails to Retract",items:[
        "Non-critical; note drag/fuel burn.",
        "Plan reduced climb/cruise performance.",
        "Continue or return at Captain’s discretion."
      ]}
    ]
  },
  {
    id:"fctl",
    title:"FLIGHT CONTROL FAILURE (HYDRAULIC LOSS)",
    tags:["flight control","hydraulic","jam","spoilers","flaps"],
    immediate:[
      "PF: Maintain control with available inputs.",
      "PM: “Flight control failure.”",
      "AUTOPILOT: DISENGAGE (if engaged)"
    ],
    checklist:[
      "Identify inoperative controls.",
      "Use remaining surfaces (rudder trim, spoilers).",
      "If flaps/slats affected: land in current flap setting or use alternate extension.",
      "If spoilers inoperative: expect longer landing distance/off-field possibility.",
      "Reduce speed to maintain controllability.",
      "Avoid complex maneuvers."
    ],
    rolesPF:"Fly with available surfaces; manage approach/takeoff.",
    rolesPM:"Run checklist, monitor speed/attitude, communicate with ATC, brief crew.",
    notes:[
      {h:"Considerations",items:[
        "Land at the nearest suitable airport.",
        "If severe loss of control: declare emergency; prepare for evacuation.",
        "If evacuation required, see EMERGENCY EVACUATION."
      ]}
    ]
  },
  {
    id:"depr",
    title:"CABIN DEPRESSURIZATION",
    tags:["pressurization","oxygen","emergency descent"],
    immediate:[
      "Oxygen Masks: ON",
      "Crew Communications: ESTABLISH",
      "PF: Initiate Emergency Descent",
      "PM: “Cabin Depressurization”"
    ],
    checklist:[
      "Seatbelt Sign: ON",
      "Thrust Levers: IDLE",
      "Speed Brakes: UP",
      "Descend to 10,000 ft (PTFS 1,500 ft) or MSA.",
      "Notify ATC of emergency descent.",
      "Prepare to divert to nearest suitable airport."
    ],
    rolesPF:"Immediate descent; maintain control; command actions.",
    rolesPM:"Run checklist; monitor profile; communicate with ATC; brief crew.",
    notes:[
      {h:"During Cruise",items:[
        "Initiate descent immediately.",
        "PF pitches down to control speed (≈300–280 kts).",
        "PM runs checklists and informs cabin."
      ]},
      {h:"Approach/Landing",items:[
        "If below 10,000 ft, continue to runway.",
        "Keep oxygen on if required.",
        "Expect high workload on final; arrange medical/evac as needed."
      ]}
    ]
  },
  {
    id:"evac",
    title:"EMERGENCY EVACUATION",
    tags:["evacuation","fire","smoke","ditch","abandon aircraft"],
    immediate:[
      "Parking Brake: SET",
      "Engine Start Levers (both): CUTOFF",
      "ELT (if available): ON",
      "Flaps (if available): 40 (PTFS 5/5)",
      "Announce: “Evacuate, Evacuate, Evacuate!”"
    ],
    checklist:[
      "Open emergency exits.",
      "Direct passengers and crew to evacuate quickly.",
      "Leave all baggage behind.",
      "Use slides/exits; otherwise direct to safe ground.",
      "Move at least 500 ft upwind once outside."
    ],
    rolesPF:"",
    rolesPM:"",
    notes:[
      {h:"Additional Considerations",items:[
        "Captain orders evacuation unless incapacitated.",
        "Assess exterior conditions before opening exits.",
        "Belly/gear collapse: evacuate immediately after stop.",
        "Crew leads and assists passengers.",
        "Ditching: ensure life vests on; inflate outside.",
        "After majority out: check lavatory; ensure all evacuated.",
        "Retrieve necessary documents for investigation if safe."
      ]}
    ]
  }
];

const app=document.getElementById("app");
const gate=document.getElementById("gate");
const passInput=document.getElementById("pass");
const unlockBtn=document.getElementById("unlock");
const rememberBtn=document.getElementById("remember");
const logoutBtn=document.getElementById("logout");
const navDiv=document.getElementById("nav");
const quickDiv=document.getElementById("quick");
const cardsDiv=document.getElementById("cards");
const searchBox=document.getElementById("search");
const clearBtn=document.getElementById("clear");
const bigBtn=document.getElementById("big");
const compactBtn=document.getElementById("compact");
const immediateOnlyBtn=document.getElementById("immediateOnly");
const sticky=document.getElementById("sticky");
const stickyList=document.getElementById("stickyList");

function ab2hex(buffer){const bytes=new Uint8Array(buffer);return Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("")}
async function sha256(str){const enc=new TextEncoder();const buf=await crypto.subtle.digest("SHA-256",enc.encode(str));return ab2hex(buf)}
async function tryUnlock(){
  const v=passInput.value.trim();
  if(!v)return;
  const h=await sha256(v);
  if(h===PASS_HASH){
    if(rememberBtn.classList.contains("on")) localStorage.setItem("swaptfs_qrh","1");
    gate.classList.add("hide");app.classList.remove("hide");renderAll("index");passInput.value="";
  }else{
    passInput.value="";passInput.placeholder="Incorrect code";passInput.focus();
  }
}

if(localStorage.getItem("swaptfs_qrh")==="1"){gate.classList.add("hide");app.classList.remove("hide");renderAll("index")}
rememberBtn.addEventListener("click",()=>rememberBtn.classList.toggle("on"));
unlockBtn.addEventListener("click",tryUnlock);
passInput.addEventListener("keydown",e=>{if(e.key==="Enter")tryUnlock()});
logoutBtn.addEventListener("click",()=>{localStorage.removeItem("swaptfs_qrh");location.reload()});

function pill(key,val){return `<span class="pill"><strong>${key}:</strong> ${val}</span>`}
function stepHtml(txt){return `<div class="step"><div class="chk"></div><p>${txt}</p></div>`}
function listHtml(arr){return `<div class="list">${arr.map(stepHtml).join("")}</div>`}
function blockHtml(b){
  if(b.type==="kv"){return `<div class="kv">${b.items.map(i=>pill(i[0],i[1])).join("")}</div>`}
  if(b.type==="text"){return `<p style="margin:0">${b.html}</p>`}
  if(b.type==="quick"){return `<div class="quick-index">${b.items.map(([t,id])=>`<button class="q" data-goto="${id}">${t}</button>`).join("")}</div>`}
  return ""
}
function makeCard(title,inner,cls=""){return `<div class="card ${cls}"><h3>${title}</h3>${inner}</div>`}
function sectionNotes(notes){
  return notes.map(n=>makeCard(n.h,`<div class="list">${n.items.map(x=>`<div class="step"><div class="chk"></div><p>${x}</p></div>`).join("")}</div>`,"half")).join("")
}
function rolesHtml(pf,pm){
  if(!pf&&!pm) return "";
  return `<div class="grid">
    <div class="card half"><h3>PF (Pilot Flying)</h3><p style="margin:0">${pf}</p></div>
    <div class="card half"><h3>PM (Pilot Monitoring)</h3><p style="margin:0">${pm}</p></div>
  </div>`
}

function renderNav(activeId,filter=""){
  const items=chapters.filter(c=>{
    if(!filter) return true;
    const hay=(c.title+" "+(c.tags||[]).join(" ")).toLowerCase();
    return hay.includes(filter.toLowerCase());
  });
  navDiv.innerHTML=items.map(c=>`<button class="navbtn ${c.id===activeId?"active":""}" data-id="${c.id}">${c.title}</button>`).join("");
  quickDiv.innerHTML="";
  const qi=chapters.find(x=>x.id==="index");
  if(qi){
    quickDiv.innerHTML=qi.blocks[0].items.map(([t,id])=>`<button class="q" data-goto="${id}">${t}</button>`).join("");
  }
}

function renderContent(id){
  const c=chapters.find(x=>x.id===id)||chapters[0];
  cardsDiv.innerHTML="";
  sticky.classList.add("hide");
  stickyList.innerHTML="";
  if(c.blocks){
    c.blocks.forEach(b=>{
      cardsDiv.insertAdjacentHTML("beforeend",makeCard(c.title,blockHtml(b)));
    });
  }else{
    if(c.immediate?.length){
      sticky.classList.remove("hide");
      stickyList.innerHTML=c.immediate.map(x=>stepHtml(x)).join("");
      cardsDiv.insertAdjacentHTML("beforeend",makeCard("Immediate Actions",listHtml(c.immediate)));
    }
    if(c.checklist?.length){
      cardsDiv.insertAdjacentHTML("beforeend",makeCard("Checklist Actions",listHtml(c.checklist)));
    }
    if(c.rolesPF||c.rolesPM){
      cardsDiv.insertAdjacentHTML("beforeend",rolesHtml(c.rolesPF,c.rolesPM));
    }
    if(c.notes?.length){
      const html=sectionNotes(c.notes);
      cardsDiv.insertAdjacentHTML("beforeend",html);
    }
    const meta=`<div class="kv" style="margin-top:8px">${pill("Chapter",c.title)}${pill("Tags",(c.tags||[]).join(", ")||"—")}</div>`;
    cardsDiv.insertAdjacentHTML("beforeend",makeCard("Reference",meta,"half"));
  }
  attachChecks();
}

function attachChecks(){
  cardsDiv.querySelectorAll(".chk").forEach(el=>{
    el.addEventListener("click",()=>el.classList.toggle("done"))
  });
  stickyList.querySelectorAll(".chk").forEach(el=>{
    el.addEventListener("click",()=>el.classList.toggle("done"))
  });
  cardsDiv.querySelectorAll(".q,[data-goto]").forEach(el=>{
    el.addEventListener("click",()=>{
      const id=el.getAttribute("data-goto");
      if(id){selectChapter(id);window.scrollTo({top:0,behavior:"smooth"})}
    })
  });
}

function renderAll(id){
  renderNav(id);
  renderContent(id);
}

function selectChapter(id){
  renderNav(id,searchBox.value.trim());
  renderContent(id);
}

navDiv.addEventListener("click",e=>{
  const b=e.target.closest("button[data-id]");
  if(!b) return;
  selectChapter(b.getAttribute("data-id"));
});

quickDiv.addEventListener("click",e=>{
  const b=e.target.closest("[data-goto]");
  if(!b) return;
  selectChapter(b.getAttribute("data-goto"));
});

searchBox.addEventListener("input",()=>{renderNav(undefined,searchBox.value.trim())});
clearBtn.addEventListener("click",()=>{searchBox.value="";renderNav(undefined,"")});

bigBtn.addEventListener("click",()=>{document.body.classList.toggle("bigtext")});
compactBtn.addEventListener("click",()=>{document.body.classList.toggle("compact")});

immediateOnlyBtn.addEventListener("click",()=>{
  const on=immediateOnlyBtn.classList.toggle("on");
  const active=chapters.find(c=>document.querySelector(".navbtn.active")?.getAttribute("data-id")===c.id) || chapters.find(c=>c.id==="index");
  if(!active || active.blocks){return}
  cardsDiv.innerHTML="";
  sticky.classList.add("hide");
  stickyList.innerHTML="";
  if(on){
    sticky.classList.remove("hide");
    stickyList.innerHTML=active.immediate.map(x=>stepHtml(x)).join("");
    cardsDiv.insertAdjacentHTML("beforeend",makeCard("Immediate Actions",listHtml(active.immediate)));
  }else{
    renderContent(active.id);
  }
  attachChecks();
});

document.addEventListener("keydown",e=>{
  if(e.key==="/"){e.preventDefault();searchBox.focus()}
  if(e.key.toLowerCase()==="g"){selectChapter("index")}
  if(e.key.toLowerCase()==="i"){immediateOnlyBtn.click()}
  if(e.key.toLowerCase()==="b"){bigBtn.click()}
});

renderNav("index");
renderContent("index");
</script>
</body>
</html>
